(function () {
  // ---------- INIT ----------
  window.m3u8Store = window.m3u8Store || [];
  window.m3u8ExportHistory = window.m3u8ExportHistory || []; // History export
  
  // Variabel untuk melacak urutan klik episode
  let episodeClickCounter = 0;
  let lastClickedEpisode = null;

  // Settings untuk auto close tab & auto export
  const AUTO_CLOSE_SETTINGS = {
    enabled: true, // Default enable auto close tab
    delay: 500 // 0.5 detik setelah export
  };

  const AUTO_EXPORT_SETTINGS = {
    enabled: true, // Default enable auto export
    delay: 2000, // 2 detik setelah data terakhir
    minDataCount: 1 // Minimal data untuk auto export
  };

  let autoExportTimer = null;
  let lastDataTimestamp = null;

  function extractEpisodeFromURL(url) {
    // Pertama coba ekstrak dari URL seperti sebelumnya
    const match = url.match(/_(\d{1,3})\//);
    const episodeFromURL = match ? parseInt(match[1], 10) : null;
    
    // Jika dari URL dapat episode number, gunakan itu
    if (episodeFromURL) return episodeFromURL;
    
    // Jika dari URL null, gunakan lastClickedEpisode atau increment counter
    if (lastClickedEpisode) {
      return lastClickedEpisode;
    } else {
      episodeClickCounter++;
      return episodeClickCounter;
    }
  }

  // Setup event listener untuk melacak klik pada episode
  document.addEventListener('click', function(e) {
    // Cari elemen yang mungkin merupakan tombol/link episode
    const target = e.target;
    const isEpisodeElement = target.closest('a[href*="episode"]') || 
                            target.closest('button') ||
                            target.closest('[data-episode]') ||
                            target.closest('.episode');
    
    if (isEpisodeElement) {
      episodeClickCounter++;
      lastClickedEpisode = episodeClickCounter;
      console.log(`%c[Episode Click]`, "color: cyan;", `Episode ${lastClickedEpisode} terdeteksi`);
    }
  });

  function saveRecord(url) {
    if (window.m3u8Store.some(r => r.url === url)) return;

    const episodeFromURL = extractEpisodeFromURL(url);
    const record = {
      pageURL: location.href,
      url: url,
      episodeDisplay: (document.querySelector(".ml-6")?.innerText || "").trim(),
      episodeNumber: episodeFromURL,
      timestamp: new Date().toISOString(),
      exported: false // Flag untuk menandai sudah diexport atau belum
    };
    window.m3u8Store.push(record);

    // Update timestamp data terakhir
    lastDataTimestamp = Date.now();
    
    // Hanya show toast untuk 5 data pertama atau jika ada data baru yang penting
    if (window.m3u8Store.length <= 5 || episodeFromURL) {
      showToast(record);
    }
    
    updateDataCount();
    console.log(
      `%c[M3U8 #${window.m3u8Store.length}]`,
      "color: lime; font-weight: bold;",
      "\nEpisode:", record.episodeNumber ?? record.episodeDisplay,
      "\nURL :", record.url,
      "\nPage :", record.pageURL
    );

    // Start auto export timer jika enabled
    if (AUTO_EXPORT_SETTINGS.enabled && window.m3u8Store.length >= AUTO_EXPORT_SETTINGS.minDataCount) {
      startAutoExportTimer();
    }
  }

  // ---------- AUTO EXPORT FEATURE ----------
  function startAutoExportTimer() {
    // Clear existing timer
    if (autoExportTimer) {
      clearTimeout(autoExportTimer);
    }
    
    // Set new timer
    autoExportTimer = setTimeout(() => {
      if (window.m3u8Store.length > 0 && AUTO_EXPORT_SETTINGS.enabled) {
        console.log(`%c[Auto Export] Data stabil selama ${AUTO_EXPORT_SETTINGS.delay}ms, melakukan export otomatis...`, "color: green; font-weight: bold;");
        autoExportData();
      }
    }, AUTO_EXPORT_SETTINGS.delay);
  }

  function autoExportData() {
    if (!window.m3u8Store.length) return;

    const filename = `m3u8-auto-${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
    
    // Tandai data yang diexport
    const unexportedData = window.m3u8Store.filter(item => !item.exported);
    unexportedData.forEach(item => item.exported = true);

    // Simpan history export
    const exportRecord = {
      filename: filename,
      timestamp: new Date().toISOString(),
      dataCount: window.m3u8Store.length,
      newDataCount: unexportedData.length,
      auto: true // Tandai sebagai auto export
    };
    window.m3u8ExportHistory.push(exportRecord);

    const json = JSON.stringify(window.m3u8Store, null, 2);
    const blob = new Blob([json], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);

    updateDataCount();
    
    console.log(`%c[Auto Export] ✅ ${unexportedData.length} data diexport ke ${filename}`, "color: lime; font-weight: bold;");
    
    // Auto close tab setelah export jika enabled
    if (AUTO_CLOSE_SETTINGS.enabled) {
      setTimeout(() => {
        closeCurrentTab();
      }, AUTO_CLOSE_SETTINGS.delay);
    }
  }

  // ---------- HOOK FETCH ----------
  const origFetch = window.fetch;
  window.fetch = async (...args) => {
    const res = await origFetch(...args);
    if (args[0] && args[0].toString().includes(".m3u8")) {
      saveRecord(args[0].toString());
    }
    return res;
  };

  // ---------- HOOK XHR ----------
  const origOpen = XMLHttpRequest.prototype.open;
  XMLHttpRequest.prototype.open = function (method, url, ...rest) {
    if (url && url.toString().includes(".m3u8")) {
      this.addEventListener("load", () => saveRecord(url.toString()));
    }
    return origOpen.call(this, method, url, ...rest);
  };

  // ---------- FITUR AUTO CLOSE TAB ----------
  window.toggleAutoCloseTab = function() {
    AUTO_CLOSE_SETTINGS.enabled = !AUTO_CLOSE_SETTINGS.enabled;
    updateAutoCloseTabButton();
    
    const status = AUTO_CLOSE_SETTINGS.enabled ? 'diaktifkan' : 'dinonaktifkan';
    toastInfo(`Auto Close Tab ${status}`, 2000);
    
    // Simpan preference ke localStorage
    localStorage.setItem('m3u8AutoCloseTab', AUTO_CLOSE_SETTINGS.enabled);
  };

  window.toggleAutoExport = function() {
    AUTO_EXPORT_SETTINGS.enabled = !AUTO_EXPORT_SETTINGS.enabled;
    updateAutoExportButton();
    
    const status = AUTO_EXPORT_SETTINGS.enabled ? 'diaktifkan' : 'dinonaktifkan';
    toastInfo(`Auto Export ${status} (${AUTO_EXPORT_SETTINGS.delay}ms)`, 2000);
    
    // Simpan preference ke localStorage
    localStorage.setItem('m3u8AutoExport', AUTO_EXPORT_SETTINGS.enabled);
  };

  function updateAutoCloseTabButton() {
    const stickyToast = document.getElementById("m3u8-sticky-export");
    if (!stickyToast) return;
    
    let autoCloseBtn = stickyToast.querySelector(".auto-close-tab-btn");
    if (!autoCloseBtn) {
      autoCloseBtn = document.createElement("button");
      autoCloseBtn.className = "auto-close-tab-btn";
      autoCloseBtn.style.cssText = `
        background: #444; 
        color: #fff; 
        border: none; 
        padding: 2px 6px; 
        margin-left: 5px; 
        border-radius: 4px; 
        cursor: pointer; 
        font-size: 11px;
        border: 1px solid #666;
      `;
      autoCloseBtn.title = "Toggle Auto Close Tab setelah export";
      stickyToast.querySelector("div").appendChild(autoCloseBtn);
    }
    
    autoCloseBtn.textContent = AUTO_CLOSE_SETTINGS.enabled ? "🔴 Close Tab" : "⚪ Close Tab";
    autoCloseBtn.style.background = AUTO_CLOSE_SETTINGS.enabled ? "#e74c3c" : "#444";
    autoCloseBtn.onclick = window.toggleAutoCloseTab;
  }

  function updateAutoExportButton() {
    const stickyToast = document.getElementById("m3u8-sticky-export");
    if (!stickyToast) return;
    
    let autoExportBtn = stickyToast.querySelector(".auto-export-btn");
    if (!autoExportBtn) {
      autoExportBtn = document.createElement("button");
      autoExportBtn.className = "auto-export-btn";
      autoExportBtn.style.cssText = `
        background: #444; 
        color: #fff; 
        border: none; 
        padding: 2px 6px; 
        margin-left: 5px; 
        border-radius: 4px; 
        cursor: pointer; 
        font-size: 11px;
        border: 1px solid #666;
      `;
      autoExportBtn.title = "Toggle Auto Export setelah data stabil";
      stickyToast.querySelector("div").appendChild(autoExportBtn);
    }
    
    autoExportBtn.textContent = AUTO_EXPORT_SETTINGS.enabled ? "🟢 Auto Export" : "⚪ Auto Export";
    autoExportBtn.style.background = AUTO_EXPORT_SETTINGS.enabled ? "#27ae60" : "#444";
    autoExportBtn.onclick = window.toggleAutoExport;
  }

  function closeCurrentTab() {
    console.log("%c[Auto Close Tab] Menutup tab...", "color: red; font-weight: bold;");
    
    // Coba berbagai method untuk close tab
    try {
      // Method 1: window.close() untuk tab/window yang dibuka oleh script
      window.close();
    } catch (e) {
      try {
        // Method 2: Untuk tab utama, buka blank page lalu close
        window.open('', '_self')?.close();
      } catch (e2) {
        // Method 3: Redirect ke blank page
        window.location.href = 'about:blank';
      }
    }
  }

  // Load preferences dari localStorage
  const savedAutoClose = localStorage.getItem('m3u8AutoCloseTab');
  if (savedAutoClose !== null) {
    AUTO_CLOSE_SETTINGS.enabled = savedAutoClose === 'true';
  }

  const savedAutoExport = localStorage.getItem('m3u8AutoExport');
  if (savedAutoExport !== null) {
    AUTO_EXPORT_SETTINGS.enabled = savedAutoExport === 'true';
  }

  // ---------- EXPORT ALL (MANUAL) ----------
  window.exportM3U8JSON = function () {
    if (!window.m3u8Store.length) {
      toastInfo("Belum ada data di m3u8Store");
      return;
    }

    let filename = prompt("Masukkan nama file JSON:", "m3u8-data.json");
    if (!filename) return; // User menekan cancel
    if (!filename.endsWith(".json")) filename += ".json";

    // Tandai data yang diexport
    const unexportedData = window.m3u8Store.filter(item => !item.exported);
    unexportedData.forEach(item => item.exported = true);

    // Simpan history export
    const exportRecord = {
      filename: filename,
      timestamp: new Date().toISOString(),
      dataCount: window.m3u8Store.length,
      newDataCount: unexportedData.length,
      auto: false // Manual export
    };
    window.m3u8ExportHistory.push(exportRecord);

    const json = JSON.stringify(window.m3u8Store, null, 2);
    const blob = new Blob([json], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);

    updateDataCount();
    
    const toastMsg = unexportedData.length > 0 
      ? `✅ ${unexportedData.length} data baru diexport ke ${filename}`
      : `✅ Data diexport ke ${filename}`;
    
    toastSuccess(toastMsg, 1500);

    // Auto close tab setelah export jika enabled
    if (AUTO_CLOSE_SETTINGS.enabled) {
      console.log(`%c[Auto Close Tab] Menutup tab dalam ${AUTO_CLOSE_SETTINGS.delay}ms...`, "color: orange;");
      setTimeout(() => {
        closeCurrentTab();
      }, AUTO_CLOSE_SETTINGS.delay);
    }
  };

  // ---------- FITUR BARU: LIHAT DATA & CLEAR DATA ----------
  
  window.viewM3U8Data = function() {
    if (!window.m3u8Store.length) {
        toastInfo("Belum ada data untuk ditampilkan.");
        return;
    }
    console.log("--- Menampilkan Data M3U8 yang Tertangkap ---");
    console.table(window.m3u8Store.map(item => ({
      Episode: item.episodeNumber ?? item.episodeDisplay,
      URL: item.url,
      Exported: item.exported ? '✅' : '❌',
      Timestamp: item.timestamp
    })));
    
    const exportedCount = window.m3u8Store.filter(item => item.exported).length;
    console.log(`%cSummary: ${exportedCount}/${window.m3u8Store.length} data sudah diexport`, 
                "color: cyan; font-weight: bold;");
    
    toastInfo("ℹ️ Data ditampilkan di Console (tekan F12).", 2000);
  };

  window.clearM3U8Data = function() {
    if (!window.m3u8Store.length) {
        toastInfo("Data sudah kosong.");
        return;
    }
    
    const unexportedCount = window.m3u8Store.filter(item => !item.exported).length;
    let confirmMsg = "Apakah Anda yakin ingin menghapus semua data yang tertangkap?";
    
    if (unexportedCount > 0) {
      confirmMsg += `\n\n⚠️ PERINGATAN: Ada ${unexportedCount} data yang BELUM di export!`;
    }
    
    if (confirm(confirmMsg)) {
        window.m3u8Store = [];
        episodeClickCounter = 0;
        lastClickedEpisode = null;
        updateDataCount();
        toastSuccess("✅ Semua data telah dihapus.", 2000);
        console.log("%c[M3U8] Store telah dibersihkan.", "color: yellow;");
    }
  };

  // ---------- FITUR BARU: UPDATE DATA COUNT DISPLAY ----------
  function updateDataCount() {
    const stickyToast = document.getElementById("m3u8-sticky-export");
    if (!stickyToast) return;
    
    const countElement = stickyToast.querySelector(".data-count") || document.createElement("div");
    
    if (!stickyToast.querySelector(".data-count")) {
      countElement.className = "data-count";
      countElement.style.cssText = `
        font-size: 12px;
        color: #ecf0f1;
        background: #34495e;
        padding: 3px 8px;
        border-radius: 12px;
        margin-top: 5px;
        text-align: center;
        font-weight: bold;
      `;
      stickyToast.appendChild(countElement);
    }
    
    const totalCount = window.m3u8Store.length;
    const exportedCount = window.m3u8Store.filter(item => item.exported).length;
    const newDataCount = totalCount - exportedCount;
    
    let countText = `📊 Total: ${totalCount}`;
    if (exportedCount > 0) {
      countText += ` | ✅: ${exportedCount}`;
    }
    if (newDataCount > 0) {
      countText += ` | 🆕: ${newDataCount}`;
    }
    
    // Tambah status auto export
    if (AUTO_EXPORT_SETTINGS.enabled && newDataCount > 0) {
      countText += ` | ⏰: ${AUTO_EXPORT_SETTINGS.delay/1000}s`;
    }
    
    countElement.textContent = countText;
    
    // Warna background berdasarkan status data
    if (newDataCount > 0) {
      countElement.style.background = "#e74c3c"; // Merah jika ada data baru
    } else if (totalCount > 0) {
      countElement.style.background = "#27ae60"; // Hijau jika semua sudah diexport
    } else {
      countElement.style.background = "#34495e"; // Default jika kosong
    }
    
    // Animasi update count
    countElement.style.transform = "scale(1.1)";
    setTimeout(() => {
      countElement.style.transform = "scale(1)";
    }, 300);
  }

  // ---------- TOAST UI (DIMINIMALKAN) ----------
  const containerId = "m3u8-toast-container";
  function ensureToastContainer() {
    let el = document.getElementById(containerId);
    if (!el) {
      el = document.createElement("div");
      el.id = containerId;
      el.style.cssText = `
        position:fixed; top:10px; right:10px; z-index:999999;
        display:flex; flex-direction:column; gap:8px; max-width:300px;
      `;
      document.body.appendChild(el);
    }
    return el;
  }

  function makeButton(label, onClick, small = false) {
    const btn = document.createElement("button");
    btn.textContent = label;
    btn.style.cssText = `
      background:#444; color:#fff; border:none; padding:${small ? "2px 6px" : "4px 8px"};
      margin-left:5px; border-radius:4px; cursor:pointer; font-size:${small ? "11px" : "13px"};
    `;
    btn.onclick = onClick;
    return btn;
  }

  // Notifikasi Episode (auto-hide) - DIMINIMALKAN
  function showToast(record) {
    // Skip toast setelah 5 data pertama untuk mengurangi notifikasi
    if (window.m3u8Store.length > 5) return;
    
    const container = ensureToastContainer();
    const toast = document.createElement("div");
    toast.style.cssText = `
      background:#222; color:#fff; padding:8px; border-radius:6px;
      box-shadow:0 2px 6px rgba(0,0,0,0.3); font-family:sans-serif;
      animation:fadeIn 0.3s ease; font-size: 12px;
    `;

    const ep = record.episodeNumber ?? record.episodeDisplay ?? "Unknown";
    toast.innerHTML = `<div style="font-weight:bold;margin-bottom:2px">🎬 Ep ${ep}</div>`;

    const btnRow = document.createElement("div");
    btnRow.style.marginTop = "4px";
    btnRow.appendChild(makeButton("Copy", () => {
      navigator.clipboard.writeText(record.url);
      toastSuccess("URL dicopy", 1000);
    }, true));
    btnRow.appendChild(makeButton("✕", () => toast.remove(), true));

    toast.appendChild(btnRow);
    container.appendChild(toast);

    // Auto-hide lebih cepat
    setTimeout(() => {
      toast.style.transition = "opacity 0.3s";
      toast.style.opacity = "0";
      setTimeout(() => toast.remove(), 300);
    }, 2000);
  }

  // Sticky Export All Toast
  (function showStickyExport() {
    const container = ensureToastContainer();
    let existing = document.getElementById("m3u8-sticky-export");
    if (existing) return;

    const toast = document.createElement("div");
    toast.id = "m3u8-sticky-export";
    toast.style.cssText = `
      background:#2c3e50; color:#fff; padding:10px; border-radius:6px;
      box-shadow:0 2px 6px rgba(0,0,0,0.4); font-family:sans-serif;
    `;
    toast.innerHTML = `<div style="font-weight:bold;margin-bottom:6px">📂 Export M3U8</div>`;

    const btnRow = document.createElement("div");
    btnRow.appendChild(makeButton("Export All", () => window.exportM3U8JSON()));
    btnRow.appendChild(makeButton("View", () => window.viewM3U8Data(), true));
    btnRow.appendChild(makeButton("Clear", () => window.clearM3U8Data(), true));
    btnRow.appendChild(makeButton("Dedupe", () => window.deduplicateM3U8(), true));

    toast.appendChild(btnRow);
    container.appendChild(toast);
    
    // Tambahkan tombol auto close tab dan auto export
    updateAutoCloseTabButton();
    updateAutoExportButton();
    updateDataCount();
  })();

  // Toast functions dengan durasi lebih pendek
  function toastInfo(msg, duration = 2000) {
    const c = ensureToastContainer();
    const el = document.createElement("div");
    el.style.cssText = `background:#3498db;color:#fff;padding:6px 8px;border-radius:6px;font-size:12px;`;
    el.textContent = msg;
    c.appendChild(el);
    setTimeout(() => el.remove(), duration);
  }

  function toastSuccess(msg, duration = 2000) {
    const c = ensureToastContainer();
    const el = document.createElement("div");
    el.style.cssText = `background:#2ecc71;color:#fff;padding:6px 8px;border-radius:6px;font-size:12px;`;
    el.textContent = msg;
    c.appendChild(el);
    setTimeout(() => el.remove(), duration);
  }

  // ---------- CLEAN DUPLICATE ----------
  window.deduplicateM3U8 = function () {
    const originalCount = window.m3u8Store.length;
    const unique = [];
    const seen = new Set();
    for (const rec of window.m3u8Store) {
      if (!seen.has(rec.url)) {
        seen.add(rec.url);
        unique.push(rec);
      }
    }
    const removedCount = originalCount - unique.length;
    window.m3u8Store = unique;
    updateDataCount();
    toastSuccess(`✅ ${removedCount} duplikat dibersihkan`, 2000);
  };

  console.log("%c[OK] M3U8 Sniffer aktif. Semua URL akan dicatat di window.m3u8Store", "color: orange;");
  console.log("%c[Auto Close Tab] " + (AUTO_CLOSE_SETTINGS.enabled ? "AKTIF 🔴" : "NONAKTIF ⚪"), "color: cyan;");
  console.log("%c[Auto Export] " + (AUTO_EXPORT_SETTINGS.enabled ? `AKTIF 🟢 (${AUTO_EXPORT_SETTINGS.delay}ms)` : "NONAKTIF ⚪"), "color: green;");
})();
